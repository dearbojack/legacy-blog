<!DOCTYPE html><html data-saber-ssr><head><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta http-equiv="X-UA-Compatible" content="ie=edge" /><meta data-saber-head="ssr" name="generator" content="Saber v0.11.5"><meta data-saber-head="ssr" name="description" content="《礼记·王制》有曰，“五方之民，言语不通，嗜欲不同。达其志，通其欲，东方曰寄，南方曰象，西方曰狄鞮，北方曰译。象寄者，史书中无名之译众也。盖其所为，亦无非“达其志，通其欲”也。"><meta data-saber-head="ssr" name="description" content="本文为SwiftGG项目组翻译文章，原文链接在此。
原作者：Soroush Khanlou
原标题：Just Controllers
翻译：PlayerUnkown
译文版权归译者所有，商业转载请联系译者。
"> <title>不要视图，只要控制器，成不？ - 象寄</title> <link data-saber-head="ssr" rel="alternate" title="象寄 - Feed" type="application/atom+xml" href="/atom.xml"><style data-vue-ssr-id="60268c6a:0">blockquote,body,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,ol,p,pre,ul{margin:0;padding:0}body{font:400 16px/1.5 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol;color:#111;background-color:#fdfdfd;-webkit-text-size-adjust:100%;-webkit-font-feature-settings:"kern" 1;-moz-font-feature-settings:"kern" 1;-o-font-feature-settings:"kern" 1;font-feature-settings:"kern" 1;font-kerning:normal;display:flex;min-height:100vh;flex-direction:column}blockquote,dl,figure,h1,h2,h3,h4,h5,h6,ol,p,pre,ul{margin-bottom:15px}main{display:block}img{max-width:100%;vertical-align:middle}figure>img{display:block}figcaption{font-size:14px}ol,ul{margin-left:30px}li>ol,li>ul{margin-bottom:0}h1,h2,h3,h4,h5,h6{font-weight:400}a{color:#2a7ae2;text-decoration:none}a:visited{color:#1756a9}a:hover{color:#111;text-decoration:underline}.social-media-list a:hover{text-decoration:none}.social-media-list a:hover .username{text-decoration:underline}blockquote{color:#828282;border-left:4px solid #e8e8e8;padding-left:15px;font-size:18px;letter-spacing:-1px;font-style:italic}blockquote>:last-child{margin-bottom:0}code,pre{font-size:15px;border:1px solid #e8e8e8;border-radius:3px;background-color:#eef}code{padding:1px 5px}pre{padding:8px 12px;overflow-x:auto}pre>code{border:0;padding-right:0;padding-left:0}.wrapper{max-width:770px;margin-right:auto;margin-left:auto;padding-right:15px;padding-left:15px}@media screen and (min-width:800px){.wrapper{max-width:740px;padding-right:30px;padding-left:30px}}.footer-col-wrapper:after,.wrapper:after{content:"";display:table;clear:both}.orange{color:#f66a0a}.grey{color:#828282}.svg-icon{width:16px;height:16px;display:inline-block;fill:currentColor;padding:5px 3px 2px 5px;vertical-align:text-bottom}table{margin-bottom:30px;width:100%;text-align:left;color:#3f3f3f;border-collapse:collapse;border:1px solid #e8e8e8}table tr:nth-child(2n){background-color:#f7f7f7}table td,table th{padding:10px 15px}table th{background-color:#f0f0f0;border:1px solid #dedede;border-bottom-color:#c9c9c9}table td{border:1px solid #e8e8e8}.site-header{border-top:5px solid #424242;border-bottom:1px solid #e8e8e8;min-height:55.95px;line-height:54px;position:relative}.site-title{font-size:26px;font-weight:300;letter-spacing:-1px;margin-bottom:0;float:left}@media screen and (max-width:600px){.site-title{padding-right:45px}}.site-title,.site-title:visited{color:#424242}.site-nav{position:absolute;top:9px;right:15px;background-color:#fdfdfd;border:1px solid #e8e8e8;border-radius:5px;text-align:right}.site-nav .nav-trigger{display:none}.site-nav .menu-icon{float:right;width:36px;height:26px;line-height:0;padding-top:10px;text-align:center}.site-nav .menu-icon>svg path{fill:#424242}.site-nav label[for=nav-trigger]{display:block;float:right;width:36px;height:36px;z-index:2;cursor:pointer}.site-nav input~.trigger{clear:both;display:none}.site-nav input:checked~.trigger{display:block;padding-bottom:5px}.site-nav .page-link{color:#111;line-height:1.5;display:block;padding:5px 10px;margin-left:20px}.site-nav .page-link:not(:last-child){margin-right:0}@media screen and (min-width:600px){.site-nav{position:static;float:right;border:none;background-color:inherit}.site-nav .menu-icon,.site-nav label[for=nav-trigger]{display:none}.site-nav input~.trigger{display:block}.site-nav .page-link{display:inline;padding:0;margin-left:auto}.site-nav .page-link:not(:last-child){margin-right:20px}}.pagination{margin-bottom:25px;font-size:.875rem}.pagination .next-link,.pagination .prev-link{border:1px solid #e8e8e8;padding:5px 10px;color:#111}.site-footer{border-top:1px solid #e8e8e8;padding:30px 0}.footer-heading{font-size:18px;margin-bottom:15px}.contact-list,.social-media-list{list-style:none;margin-left:0}.footer-col-wrapper{font-size:15px;color:#828282;margin-left:-15px}.footer-col{width:-webkit-calc(100% - 15px);width:calc(100% - 15px);margin-bottom:15px;padding-left:15px}.footer-col-1,.footer-col-2{width:-webkit-calc(50% - 15px);width:calc(50% - 15px)}.footer-col-3{width:-webkit-calc(100% - 15px);width:calc(100% - 15px)}@media screen and (min-width:800px){.footer-col-1{width:-webkit-calc(35% - 15px);width:calc(35% - 15px)}.footer-col-2{width:-webkit-calc(20% - 15px);width:calc(20% - 15px)}.footer-col-3{width:-webkit-calc(45% - 15px);width:calc(45% - 15px)}}@media screen and (min-width:600px){.footer-col{float:left}}.page-content{padding:30px 0;flex:1 0 auto}.page-heading{font-size:32px}.post-list-heading{font-size:28px}.post-list{margin-left:0;list-style:none}.post-list>li{margin-bottom:30px}.post-meta{font-size:14px;color:#828282}.post-link{display:block;font-size:24px}.post-header{margin-bottom:30px}.post-content h1,.post-title{font-size:42px;letter-spacing:-1px;line-height:1}@media screen and (min-width:800px){.post-content h1,.post-title{font-size:42px}}.post-content{margin-bottom:30px}.post-content h2{font-size:28px}@media screen and (min-width:800px){.post-content h2{font-size:32px}}.post-content h3{font-size:22px}@media screen and (min-width:800px){.post-content h3{font-size:26px}}.post-content h4{font-size:18px}@media screen and (min-width:800px){.post-content h4{font-size:20px}}.social-media-list{display:table;margin:0 auto}.social-media-list li{float:left;margin:0 5px}.social-media-list li:first-of-type{margin-left:0}.social-media-list li:last-of-type{margin-right:0}.social-media-list li a{display:block;padding:7.5px;border:1px solid #e8e8e8}.social-media-list li:hover .svg-icon{fill:currentColor}.one-half{width:-webkit-calc(50% - 15px);width:calc(50% - 15px)}</style>  </head><body><div id="_saber" data-server-rendered="true"><div><header class="site-header"><div class="wrapper"><a href="/" rel="author" class="site-title router-link-active">象寄</a> <nav class="site-nav"><input type="checkbox" id="nav-trigger" class="nav-trigger"> <label for="nav-trigger"><span class="menu-icon"><svg viewBox="0 0 18 15" width="18px" height="15px"><path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path></svg></span></label> <div class="trigger"><a href="/" class="page-link router-link-active">Home</a><a href="/about.html" class="page-link">About</a></div></nav></div></header> <main aria-label="Content" class="page-content"><div class="wrapper"><article itemscope="itemscope" itemtype="http://schema.org/BlogPosting" class="post h-entry"><header class="post-header"><h1 itemprop="name headline" class="post-title p-name">不要视图，只要控制器，成不？</h1> <p class="post-meta"><time datetime="Mon Jun 25 2018 12:05:50 GMT+0800 (China Standard Time)" itemprop="datePublished" class="dt-published">2018-06-25</time></p></header> <div itemprop="articleBody" class="post-content e-content"><p>本文为<a rel="noopener noreferrer" target="_blank" href="https://swift.gg/">SwiftGG项目组</a>翻译文章，<a rel="noopener noreferrer" target="_blank" href="http://khanlou.com/2018/02/just-controllers/">原文链接在此</a>。
原作者：Soroush Khanlou
原标题：Just Controllers
翻译：<em>PlayerUnkown</em>
译文版权归译者所有，商业转载请联系<a href="dearbojack.github.io">译者</a>。</p> <hr> <p>苹果官方文档中提到了 MVC 的软件设计模式。不过，苹果介绍的并不是本质意义上的 MVC 。<a rel="noopener noreferrer" target="_blank" href="http://khanlou.com/2014/03/model-view-whatever/">关于这一点我之前也有写过一篇文章</a>，MVC 是为 Smalltalk 语言设计的一种设计模式。在 Smalltalk 语言里，MVC 的三个组件：模型（model）、视图（view）和控制器（controller）之间都可以相互通信。这就意味着或者视图知道如何实现一个模型，或者模型知道如何在视图中应用自己。</p> <p>我们写 iOS 软件的时候，通常会把可以直接通信的视图和模型称之为“反模式”，不推荐这么做。我们所谓的 MVC 更准确的说其实是“模型-视图-适配器（Model - View - Adapter）”。我们说的“视图控制器”（适配器）其实只是模型和视图中间沟通的一个桥梁。笼统来讲，我觉得这是对正统MVC一个不错的改良——不是把视图和模型绑在一起，而是通过一个适配器把模型和视图联系起来，这个方法不错。然而，我不得不说，在我工作中涉及到的很多系统里，其实模型和视图都是分开的。</p> <p>以上就是为什么 iOS开发里会有视图控制器的原因：把模型和视图联系起来。但是这种模式的编码会产生一些问题：有一些代码看起来既不属于模型，也不属于视图，所以我们就把这些代码放到了视图控制器里，最后视图控制器变得超级臃肿。关于这个问题，我在博客里面讨论过<a rel="noopener noreferrer" target="_blank" href="http://khanlou.com/2015/10/coordinators-redux/">很多次</a>，但这次我想说的不是这个问题。</p> <hr> <p>我私下里听到过很多关于<code>UIViewController</code>的谈论。我认为<code>UIViewController</code>这个基本类写的不是很好，这个你用 UIKit 用得越久就越能感觉到。我听说<code>UIViewController</code>这个基本类型有1万到2万行代码（那是几年前了，现在可能已经超过两万行了）。</p> <p>当我们需要把<code>UIView</code>和一个模型联系起来的时候，我们通常会把视图控制器分成一个个小的 视图控制器组件，然后再组装到一起。</p> <p>但是，这样做太大动干戈（小题大做）了。一个小地方没处理好，就会出现很多bug，而且这样的bug很难修复，也没有什么提示。然后，当你终于找到bug的时候，bug通常是对<code>didMove</code>或者<code>willMove</code>调用的顺序不对，程序忽然就好了。其实，出现了<code>didMove</code>和<code>willMove</code>已经说明这些组件一些内部状态需要清理了。</p> <p>这样的情况我自己就遇到过两次。第一次是我把视图控制器放在了<code>tableView</code>的<code>cell</code>里。出现的bug就是，table view里面的一些内容总会莫名其妙地消失。然后过了好几个月，我才意识到我对 table view cells的生命周期理解有误。</p> <p>在我改正了一些对<code>-addChildViewController</code>的调用之后，程序就正常运行了。</p> <p>这件事让我看到了一个很大的问题：视图控制器的视图并不是一个普普通通的视图。它知道自己不是一个普通的视图，而是一个视图控制器的视图，它有自己一些特性。</p> <p>回过头去看，一切都很明显。<code>UIViewController</code>怎么知道什么时候该去调用<code>viewDidLayoutSubviews</code>?肯定是<code>view</code>向它发送了请求，这就意味着视图对视图控制器是有一些了解的。</p> <p>第二次是最近碰到的，这次我是在把一个视图控制器的视图作为一个text field 的<code>inputAccessoryView</code>。我是在实现一个通信软件（类似 iMessage）里<code>textField</code>贴在屏幕底部的功能，整个过程十分挫败。我花了整整一天时间都没搞定，最后还是把这个视图转换成了一个普通的视图。</p> <hr> <p>所以，我们通常想让<code>UIViewController1</code>做的是哪些事情呢？</p> <ul><li>承载视图</li> <li>把模型和视图联系起来</li></ul> <p>那<code>UIViewController1</code>还做了那些我们并不十分在意的事呢？</p> <ul><li>为子视图控制器提供存储</li> <li>把外观和过渡动画推送给子视图控制器</li> <li>可以在类似<code>UINavigationController</code>的容器中显示</li> <li>内存过低通知</li> <li>处理状态栏</li> <li>保存状态、恢复状态</li></ul> <p>知道了这些，在一些特殊情况下，我们要做一个替代视图控制器的东西的时候，我们就知道了哪些东西是我们并不需要的。我喜欢这样，因为这样可以快速地解决问题，同时也符合我“自己的事情自己做”的性格。</p> <p>还有一个问题，这个东西怎么命名呢？我觉得命名成一个视图控制器不太好，很容易被误解为一个<code>UIViewController</code>的子类。或者，我们就叫它<code>Controller</code>?我觉得可以（<a rel="noopener noreferrer" target="_blank" href="http://khanlou.com/2014/11/a-controller-by-any-other-name/">尽管我之前可能有其他观点</a>），因为它的作用就是iOS MVC设计框架中控制器的作用（把视图和模型联系起来），但是还有其他一些备选：<code>Binder</code>（粘合）, <code>Binding</code>（捆绑）, <code>Pair</code>（配对）, <code>Mediator</code>（中介）, <code>Concierge</code>（前台）。</p> <p>这个做法还有一个好处是，<strong>特别好写</strong>。</p> <div class="saber-highlight" data-lang="swift"><pre class="saber-highlight-code language-swift"><code class="language-swift">class DestinationTextFieldController {

    var destination: Destination?

    weak var delegate: DestinationTextFieldControllerDelegate?

    let textField = UITextField().configure({
        $0.autocorrectionType = .no
        $0.clearButtonMode = .always
    })
    
}</code></pre></div><p>不用<code>UIViewController</code>的子类，写个这样的东西，可能会有人喊，“异教徒！烧死他！”但是，当<code>UIViewController</code>没有把自己该做的事情做好的时候，我们就应该抛弃它。</p> <p>大家已将知道怎么给自己的新对象加新功能了。在我的这个例子中，控制器成了<code>textField</code>的代理，文字变化时发出事件（以及域元数据 domain metadta），同时提供更新视图（这个例子中是<code>textField</code>）的接口。</p> <div class="saber-highlight" data-lang="swift"><pre class="saber-highlight-code language-swift"><code class="language-swift">extension DestinationTextFieldController {
	var isActive: Bool {
		return self.textField.isFirstResponder
	}

	func update(with destination: Destination) {
		self.destination = destination
		configureView()
	}
	
	private func configureView() {
		textField.text = destination.descriptionForDisplay
	}
}</code></pre></div><p>使用这种新的控制器你还需要做其他几件事：</p> <ul><li>你得新建一个实例变量来存储数据</li> <li>你得负责一些触发事件——因为它不是一个视图控制器，没有<code>-viewDidAppear</code></li> <li>你不是在<code>UIKit</code>框架里面了，所以其他一些<code>UIKit</code>的特性（<a rel="noopener noreferrer" target="_blank" href="https://developer.apple.com/documentation/uikit/uitraitcollection">UITraitCollection</a>, <a rel="noopener noreferrer" target="_blank" href="https://developer.apple.com/documentation/uikit/uiview/positioning_content_relative_to_the_safe_area">safe area insets</a>, 或者<a rel="noopener noreferrer" target="_blank" href="https://developer.apple.com/documentation/uikit/uiresponder">UIResponder</a>）你都不能再使用了。如果要使用，你必须自己实现。</li></ul> <p>使用这个对象不是很难，不过你还是需要写明它的数据存储方式， 防止它的内存被回收。</p> <div class="saber-highlight" data-lang="swift"><pre class="saber-highlight-code language-swift"><code class="language-swift">class MyViewController: UIViewController, DestinationTextFieldControllerDelegate {


	let destinationViewController = DestinationTextFieldController()
	
	override func viewDidLoad() {
		super.viewDidLoad()
		destinationViewController.delegate = self
		view.addSubview(destinationViewController.view)
	}
	
	//handle any delegate methods

}</code></pre></div><p>话说回来，即使你使用我说的这个方法，其他大部分的视图应该还会是视图控制器和<code>UIViewController</code>的子类。不过，在某些特殊的情况下，整合一个视图控制器会耗费你过多的精力，这时候采用这种方法，就可以避免再次被<code>UIKit</code>折磨。</p></div> <!----> <a href="/posts/fy011.html" hidden="hidden" class="u-url router-link-exact-active router-link-active"></a></article></div></main> <footer class="site-footer h-card"><div class="wrapper"><div class="footer-col-wrapper"><div class="footer-col one-half"><h2 class="footer-heading">象寄</h2> <ul class="contact-list"><li class="p-name">dearbojack</li> <li><a href="mailto:ross4han@gmail.com" class="u-email">ross4han@gmail.com</a></li></ul></div> <div class="footer-col one-half"><p>《礼记·王制》有曰，“五方之民，言语不通，嗜欲不同。达其志，通其欲，东方曰寄，南方曰象，西方曰狄鞮，北方曰译。象寄者，史书中无名之译众也。盖其所为，亦无非“达其志，通其欲”也。</p></div> <div class="social-links"><ul class="social-media-list"><!----> <!----> <!----> <li><a title="dearbojack" rel="noopener noreferrer" target="_blank" href="https://github.com/dearbojack"><svg class="svg-icon grey"><use xlink:href="/_saber/images/minima-social-icons.198a7e12.svg#github"></use></svg></a></li> <!----> <!----> <!----> <li><a title="dearbojack" rel="noopener noreferrer" target="_blank" href="https://twitter.com/dearbojack"><svg class="svg-icon grey"><use xlink:href="/_saber/images/minima-social-icons.198a7e12.svg#twitter"></use></svg></a></li> <!----> <!----> <!----> <!----> <li><a title="rss" href="/atom.xml"><svg class="svg-icon grey"><use xlink:href="/_saber/images/minima-social-icons.198a7e12.svg#rss"></use></svg></a></li></ul></div></div></div></footer></div></div><script src="/_saber/js/client.db0edabe.js" defer></script><script src="/_saber/js/page--_posts-fy011-md.eaf6fb2b.js" defer></script></body></html>
